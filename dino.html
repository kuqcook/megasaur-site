<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MEGASaur Runner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: #eaf6f6;
    }
    canvas {
      background: #fff;
      display: block;
      margin: 20px auto;
      border: 2px solid #000;
    }
    #nickname-form, #game-over {
      margin-top: 20px;
    }
    #nickname-error {
      color: red;
      display: none;
    }
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    #leaderboard {
      margin-left: 20px;
      text-align: left;
    }
    #touch-btn {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      padding: 10px 20px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>ü¶ñ MEGASaur Runner</h1>

  <div id="nickname-form">
    <label for="nickname">Enter your nickname:</label>
    <input type="text" id="nickname" placeholder="e.g. DinoMaster" maxlength="20" />
    <p id="nickname-error">Nickname already taken, please choose another.</p>
    <button id="start-game-btn" onclick="startGame()">Start Game</button>
  </div>

  <div id="game-over">
    <h2>Game Over!</h2>
    <p id="final-score"></p>
    <button id="restart-game-btn">Play Again</button>
  </div>

  <div class="container">
    <canvas id="game" width="600" height="300"></canvas>
    <div id="leaderboard">
      <h2>üèÜ Top 10 Dino Tamers</h2>
      <ol id="scores"></ol>
    </div>
  </div>

  <button id="touch-btn">TAP TO JUMP</button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, query, orderByChild, get } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyACFWv9js50STTex2TzTjEubBP_3heZXgc",
      authDomain: "megasaur-runner.firebaseapp.com",
      databaseURL: "https://megasaur-runner-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "megasaur-runner",
      storageBucket: "megasaur-runner.appspot.com",
      messagingSenderId: "222910326781",
      appId: "1:222910326781:web:b92195977fda4af2661b94"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let canvas = document.getElementById("game");
    let ctx = canvas.getContext("2d");
    let dino = { x: 50, y: 230, width: 30, height: 30, vy: 0, jumpPower: 10, grounded: true };
    let gravity = 0.5;
    let obstacles = [];
    let powerUps = [];
    let backgroundObjects = [];
    let score = 0;
    let gameSpeed = 3;
    let gameOver = false;
    let nickname = "";
    let hasShield = false;
    let lastFrameTime = 0;
    let lastObstacleSpawn = 0;
    let animationFrameId = null;

    const obstacleTypes = [
      { type: "gate", emoji: "‚õ©Ô∏è", width: 40, height: 40, y: 230 },
      { type: "pterodactyl", emoji: "ü¶Ö", width: 60, height: 30, y: 140 }
    ];
    const powerUpTypes = [
      { type: "shield", emoji: "üõ°Ô∏è", width: 30, height: 30, y: 230 }
    ];

    function initializeGame() {
      obstacles = [];
      powerUps = [];
      backgroundObjects = [];
      score = 0;
      gameSpeed = 3;
      gameOver = false;
      hasShield = false;
      dino.y = 230;
      dino.vy = 0;
      dino.grounded = true;
      document.getElementById("game-over").style.display = "none";
      document.getElementById("touch-btn").style.display = "block";
      return true;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = hasShield ? "#66f" : "#000";
      ctx.fillRect(dino.x, dino.y, dino.width, dino.height);

      for (let obs of obstacles) {
        ctx.fillText(obs.emoji, obs.x, obs.y);
      }
      for (let p of powerUps) {
        ctx.fillText(p.emoji, p.x, p.y);
      }
      ctx.fillStyle = "#000";
      ctx.fillText("Score: " + score, 10, 20);
    }

    function update() {
      dino.vy += gravity;
      dino.y += dino.vy;
      if (dino.y >= 230) {
        dino.y = 230;
        dino.vy = 0;
        dino.grounded = true;
      }
      for (let obs of obstacles) {
        obs.x -= gameSpeed;
        if (
          dino.x < obs.x + obs.width &&
          dino.x + dino.width > obs.x &&
          dino.y < obs.y + obs.height &&
          dino.y + dino.height > obs.y
        ) {
          if (hasShield) {
            hasShield = false;
            obstacles.splice(obstacles.indexOf(obs), 1);
          } else {
            endGame();
          }
        }
      }
      for (let p of powerUps) {
        p.x -= gameSpeed;
        if (
          dino.x < p.x + p.width &&
          dino.x + dino.width > p.x &&
          dino.y < p.y + p.height &&
          dino.y + dino.height > p.y
        ) {
          if (p.type === "shield") hasShield = true;
          powerUps.splice(powerUps.indexOf(p), 1);
        }
      }
      score++;
    }

    function loop(timestamp) {
      update();
      draw();
      animationFrameId = requestAnimationFrame(loop);
    }

    function jump() {
      if (dino.grounded) {
        dino.vy = -dino.jumpPower;
        dino.grounded = false;
      }
    }

    function endGame() {
      gameOver = true;
      cancelAnimationFrame(animationFrameId);
      document.getElementById("final-score").textContent = `${nickname}'s Score: ${score}`;
      document.getElementById("game-over").style.display = "block";
      document.getElementById("touch-btn").style.display = "none";
      saveScore(nickname, score);
    }

    function spawnObstacle() {
      const o = { ...obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)] };
      o.x = canvas.width;
      obstacles.push(o);
    }

    function spawnPowerUp() {
      const p = { ...powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)] };
      p.x = canvas.width;
      powerUps.push(p);
    }

    function saveScore(name, score) {
      const scoresRef = ref(database, 'scores');
      push(scoresRef, { name, score });
    }

    async function checkNicknameUnique(name) {
      const scoresRef = ref(database, 'scores');
      const snapshot = await get(scoresRef);
      if (!snapshot.exists()) return true;
      const scores = snapshot.val();
      return !Object.values(scores).some(entry => entry.name === name);
    }

    function showLeaderboard() {
      const scoresRef = query(ref(database, 'scores'), orderByChild('score'));
      onValue(scoresRef, snapshot => {
        const list = document.getElementById("scores");
        list.innerHTML = "";
        const items = [];
        snapshot.forEach(child => {
          items.push(child.val());
        });
        items.sort((a, b) => b.score - a.score);
        for (let i = 0; i < Math.min(10, items.length); i++) {
          const li = document.createElement("li");
          li.textContent = `${items[i].name}: ${items[i].score}`;
          list.appendChild(li);
        }
      });
    }

    async function startGame() {
      const input = document.getElementById("nickname");
      const errorText = document.getElementById("nickname-error");
      const form = document.getElementById("nickname-form");

      const proposedNickname = input.value.trim().slice(0, 20).replace(/[<>&]/g, "");
      if (!proposedNickname) {
        errorText.textContent = "Please enter a nickname.";
        errorText.style.display = "block";
        return;
      }
      const isUnique = await checkNicknameUnique(proposedNickname);
      if (!isUnique) {
        errorText.textContent = "Nickname already taken, please choose another.";
        errorText.style.display = "block";
        return;
      }
      errorText.style.display = "none";
      nickname = proposedNickname;
      form.style.display = "none";

      if (!initializeGame()) return;

      setInterval(() => {
        if (!gameOver) spawnObstacle();
      }, 2000);

      setInterval(() => {
        if (!gameOver && Math.random() < 0.3) spawnPowerUp();
      }, 5000);

      animationFrameId = requestAnimationFrame(loop);
      showLeaderboard();
    }

    window.startGame = startGame;

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("restart-game-btn").addEventListener("click", startGame);
      document.addEventListener("keydown", e => {
        if (e.code === "Space") jump();
      });
      document.getElementById("touch-btn").addEventListener("click", jump);
    });
  </script>
</body>
</html>
