<script>
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const dino = {
    x: 50,
    y: 160,
    vy: 0,
    width: 40,
    height: 40,
    jumping: false,
  };

  const gravity = 1.2;
  let obstacle = {
    x: canvas.width + 100,
    y: 160,
    width: 40,
    height: 40,
  };

  let score = 0;
  let gameOver = false;
  let nickname = "";

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw flipped dino
    ctx.save();
    ctx.translate(dino.x + dino.width / 2, dino.y);
    ctx.scale(-1, 1);
    ctx.font = "32px serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "bottom";
    ctx.fillText("ðŸ¦–", 0, 0);
    ctx.restore();

    // Obstacle
    ctx.font = "40px serif";
    ctx.textAlign = "left";
    ctx.textBaseline = "bottom";
    ctx.fillText("â›©ï¸", obstacle.x, obstacle.y + obstacle.height);

    // Score
    ctx.fillStyle = "#00f0ff";
    ctx.font = "20px monospace";
    ctx.fillText("Score: " + score, 10, 30);
  }

  function update() {
    if (gameOver) return;

    dino.y += dino.vy;
    dino.vy += gravity;

    if (dino.y > 160) {
      dino.y = 160;
      dino.vy = 0;
      dino.jumping = false;
    }

    obstacle.x -= 6;
    if (obstacle.x < -obstacle.width) {
      obstacle.x = canvas.width + Math.random() * 300;
      score++;
    }

    // Collision
    if (
      dino.x < obstacle.x + obstacle.width &&
      dino.x + dino.width > obstacle.x &&
      dino.y < obstacle.y + obstacle.height &&
      dino.y + dino.height > obstacle.y
    ) {
      gameOver = true;
      saveScore(score, nickname);
      setTimeout(() => {
        alert("ðŸ¦– Game Over! Final Score: " + score);
        document.location.reload();
      }, 300);
    }
  }

  function jump() {
    if (!dino.jumping) {
      dino.vy = -14;
      dino.jumping = true;
    }
  }

  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }

  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") jump();
  });

  document.getElementById("touch-btn").addEventListener("click", jump);

  function saveScore(newScore, name) {
    let scores = JSON.parse(localStorage.getItem("megasaurScores")) || [];
    scores.push({ name: name || "Anonymous", score: newScore });
    scores = scores.sort((a, b) => b.score - a.score).slice(0, 10);
    localStorage.setItem("megasaurScores", JSON.stringify(scores));
    showLeaderboard();
  }

  function showLeaderboard() {
    let scores = JSON.parse(localStorage.getItem("megasaurScores")) || [];
    const list = document.getElementById("scores");
    list.innerHTML = "";
    scores.forEach((entry, i) => {
      const li = document.createElement("li");
      li.textContent = `#${i + 1}: ${entry.name} â€“ ${entry.score}`;
      list.appendChild(li);
    });
  }

  function startGame() {
    const input = document.getElementById("nickname");
    nickname = input.value.trim() || "Anonymous";
    localStorage.setItem("dinoNickname", nickname);
    document.getElementById("nickname-form").style.display = "none";
    showLeaderboard();
    loop();
  }

  // Check if nickname already saved
  window.onload = () => {
    const savedName = localStorage.getItem("dinoNickname");
    if (savedName) {
      nickname = savedName;
      document.getElementById("nickname-form").style.display = "none";
      showLeaderboard();
      loop();
    } else {
      document.getElementById("nickname-form").style.display = "flex";
    }
  };
</script>
